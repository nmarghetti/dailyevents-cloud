function refreshGroup(){data.groupCode?(showLoadingMessage(),Parse.Cloud.run("getGroupByCode",{code:data.groupCode},{success:function(e){e.id?(data.groupId=e.id,data.groupName=e.name,ui.labels.title.text(data.groupName),document.title=data.groupName,refreshEvent()):(data.groupCode=null,disableElements([ui.buttons.refresh,ui.buttons.reply_yes,ui.buttons.reply_no,ui.buttons.add_comment])),hideLoadingMessage()},error:function(e){hideLoadingMessage(),showNetworkError()}})):(showErrorMessage("Unknown group"),disableElements([ui.fields.display_name,ui.fields.comment,ui.buttons.refresh,ui.buttons.reply_yes,ui.buttons.reply_no,ui.buttons.add_comment]))}function refreshEvent(){if(data.groupId){var e=new Date
disableElements([ui.buttons.refresh]),showLoadingMessage("Refreshing event..."),Parse.Cloud.run("getEvent",{groupId:data.groupId,timestamp:e.getTime(),timezone:e.getTimezoneOffset()},{success:function(e){refreshStatuses(e.statuses),refreshComments(e.comments),enableElements([ui.buttons.refresh]),hideLoadingMessage()},error:function(e){hideLoadingMessage(),showNetworkError(),enableElements([ui.buttons.refresh])}})}else refreshGroup()}function refreshStatuses(e){var t=ui.labels.participants
t.empty(),t.append($("<li/>",{"data-role":"list-divider",text:"Attending today"}))
for(var n in e)"yes"==e[n].reply&&t.append($("<li/>",{text:e[n].participant}))
t.listview("refresh")}function refreshComments(e){var t=ui.labels.comments
t.empty(),t.append($("<li/>",{"data-role":"list-divider",text:"Comments"}))
for(var n in e){var s=new Date(parseInt(e[n].timestamp)),a=toTwoDigits(s.getHours())+":"+toTwoDigits(s.getMinutes())+" "+e[n].participant,i=$("<li/>",{"data-icon":"false",html:a+": "+linkify(e[n].comment)})
i.addClass("ui-li-static"),t.append(i)}t.listview("refresh")}function linkify(e){var t=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi
return e.replace(t,'<a href="$1">$1</a>')}function confirmAttendance(){setStatus("yes")}function cancelAttendance(){setStatus("no")}function setStatus(e){var t=getDisplayName()
data.groupId?t?(disableElements([ui.buttons.reply_yes,ui.buttons.reply_no]),showLoadingMessage("Sending reply..."),Parse.Cloud.run("setStatus",{groupId:data.groupId,participant:getDisplayName(),reply:e,timestamp:getTimestamp(),timezone:getTimezone()},{success:function(e){hideLoadingMessage(),refreshEvent(),enableElements([ui.buttons.reply_yes,ui.buttons.reply_no])},error:function(e){hideLoadingMessage(),showNetworkError(),enableElements([ui.buttons.reply_yes,ui.buttons.reply_no])}})):showErrorMessage("Enter your display name"):refreshGroup()}function addComment(){var e=getComment()
data.groupId?e?(disableElements([ui.buttons.add_comment]),showLoadingMessage("Adding comment..."),Parse.Cloud.run("addComment",{groupId:data.groupId,participant:getDisplayName(),comment:e,timestamp:getTimestamp(),timezone:getTimezone()},{success:function(e){hideLoadingMessage(),ui.fields.comment.val(""),refreshEvent(),enableElements([ui.buttons.add_comment])},error:function(e){hideLoadingMessage(),showNetworkError(),enableElements([ui.buttons.add_comment])}})):showErrorMessage("Enter your comment"):refreshGroup()}function readQueryParameters(){data.groupCode=$.url().param("code"),ui.fields.display_name.val($.url().param("name"))}function enableElements(e){for(var t in e)e[t].removeClass("ui-disabled")}function disableElements(e){for(var t in e)e[t].addClass("ui-disabled")}function activateFieldValidation(){var e=[ui.fields.display_name,ui.fields.comment]
for(var t in e)e[t].keydown(checkMaxLength),e[t].keyup(checkMaxLength)
e[0].change(checkDisplayName),e[0].keydown(checkDisplayName),e[0].keyup(checkDisplayName)}function checkMaxLength(){var e=$(this).val(),t=$(this).attr("maxlength")
e.length>t&&$(this).val(e.substr(0,t))}function checkDisplayName(){var e=[ui.buttons.reply_yes,ui.buttons.reply_no,ui.buttons.add_comment]
$(this).val().trim()?enableElements(e):disableElements(e)}function bindActions(){ui.buttons.refresh.bind("click",refreshEvent),ui.buttons.reply_yes.bind("click",confirmAttendance),ui.buttons.reply_no.bind("click",cancelAttendance),ui.buttons.add_comment.bind("click",addComment),ui.fields.comment.keypress(function(e){13==e.keyCode&&(addComment(),e.preventDefault())})}function showLoadingMessage(e){e=e||"Loading...",$.mobile.showPageLoadingMsg("a",e)}function hideLoadingMessage(){$.mobile.hidePageLoadingMsg()}function showNetworkError(){showErrorMessage("Network error")}function showErrorMessage(e){$.mobile.showPageLoadingMsg("e",e,!0),setTimeout(hideLoadingMessage,3e3)}function getDisplayName(){return ui.fields.display_name.val().trim()}function getComment(){return ui.fields.comment.val().trim()}function getTimestamp(){return(new Date).getTime().toString()}function getTimezone(){return(new Date).getTimezoneOffset().toString()}function toTwoDigits(e){return 10>e?"0"+e:e}Parse.initialize("Puuy52CoyWk3c5yOIubf3NPecyNdrNw7h4AAU7Qt","inthUDhs4EiQT81QwnZbpMUe70PbJvzBn5wzYF5b","kFKmW34AIIYbHg1fqsFTFm0zfqLks4EcIIb40JXq"),Parse.serverURL="https://parseapi.back4app.com"
var data={},ui={buttons:{refresh:$("#refresh"),reply_yes:$("#reply_yes"),reply_no:$("#reply_no"),add_comment:$("#add_comment")},fields:{display_name:$("#display_name"),comment:$("#comment")},labels:{title:$("#title"),participants:$("#participants"),comments:$("#comments")}}
$(document).ready(function(){readQueryParameters(),activateFieldValidation(),bindActions(),refreshGroup()})
