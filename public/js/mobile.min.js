Parse.initialize("Puuy52CoyWk3c5yOIubf3NPecyNdrNw7h4AAU7Qt","inthUDhs4EiQT81QwnZbpMUe70PbJvzBn5wzYF5b");var data={},ui={buttons:{refresh:$("#refresh"),reply_yes:$("#reply_yes"),reply_no:$("#reply_no"),add_comment:$("#add_comment")},fields:{display_name:$("#display_name"),comment:$("#comment")},labels:{title:$("#title"),participants:$("#participants"),comments:$("#comments")}};
function refreshGroup(){data.groupCode&&Parse.Cloud.run("getGroupByCode",{code:data.groupCode},{success:function(a){a.id?(data.groupId=a.id,data.groupName=a.name,ui.labels.title.text(data.groupName),document.title=data.groupName,refreshEvent()):(data.groupCode=null,disableButtons([ui.buttons.refresh,ui.buttons.reply_yes,ui.buttons.reply_no,ui.buttons.add_comment]))},error:function(a){}})}
function refreshEvent(){if(data.groupId){disableButtons([ui.buttons.refresh]);var a=new Date;Parse.Cloud.run("getEvent",{groupId:data.groupId,timestamp:a.getTime(),timezone:a.getTimezoneOffset()},{success:function(a){refreshStatuses(a.statuses);refreshComments(a.comments);enableButtons([ui.buttons.refresh])},error:function(a){enableButtons([ui.buttons.refresh])}})}}
function refreshStatuses(a){var b=ui.labels.participants;b.empty();b.append('<li data-role="list-divider">Attending today</li>');for(var c in a)"yes"==a[c].reply&&b.append("<li>"+a[c].participant+"</li>");b.listview("refresh")}
function refreshComments(a){var b=ui.labels.comments;b.empty();b.append('<li data-role="list-divider">Comments</li>');for(var c in a){var d=new Date(parseInt(a[c].timestamp)),d=toTwoDigits(d.getHours())+":"+toTwoDigits(d.getMinutes())+" "+a[c].participant;b.append("<li>"+d+": "+a[c].comment+"</li>")}b.listview("refresh")}function confirmAttendance(){setStatus("yes")}function cancelAttendance(){setStatus("no")}
function setStatus(a){data.groupId&&(disableButtons([ui.buttons.reply_yes,ui.buttons.reply_no]),Parse.Cloud.run("setStatus",{groupId:data.groupId,participant:getDisplayName(),reply:a,timestamp:getTimestamp(),timezone:getTimezone()},{success:function(a){refreshEvent();enableButtons([ui.buttons.reply_yes,ui.buttons.reply_no])},error:function(a){enableButtons([ui.buttons.reply_yes,ui.buttons.reply_no])}}))}
function addComment(){var a=ui.fields.comment.val().trim();data.groupId&&a&&(disableButtons([ui.buttons.add_comment]),Parse.Cloud.run("addComment",{groupId:data.groupId,participant:getDisplayName(),comment:a,timestamp:getTimestamp(),timezone:getTimezone()},{success:function(a){ui.fields.comment.val("");refreshEvent();enableButtons([ui.buttons.add_comment])},error:function(a){enableButtons([ui.buttons.add_comment])}}))}
function readQueryParameters(){data.groupCode=$.url().param("code");ui.fields.display_name.val($.url().param("name"))}function enableButtons(a){for(var b in a)a[b].removeClass("ui-disabled")}function disableButtons(a){for(var b in a)a[b].addClass("ui-disabled")}
function activateFieldValidation(){var a=[ui.fields.display_name,ui.fields.comment],b;for(b in a)a[b].keydown(checkMaxLength),a[b].keyup(checkMaxLength);a[0].change(checkDisplayName);a[0].keydown(checkDisplayName);a[0].keyup(checkDisplayName)}function checkMaxLength(){var a=$(this).val(),b=$(this).attr("maxlength");a.length>b&&$(this).val(a.substr(0,b))}
function checkDisplayName(){var a=[ui.buttons.reply_yes,ui.buttons.reply_no,ui.buttons.add_comment];$(this).val().trim()?enableButtons(a):disableButtons(a)}function bindActions(){ui.buttons.refresh.bind("click",refreshEvent);ui.buttons.reply_yes.bind("click",confirmAttendance);ui.buttons.reply_no.bind("click",cancelAttendance);ui.buttons.add_comment.bind("click",addComment);ui.fields.comment.keypress(function(a){13==a.keyCode&&(addComment(),a.preventDefault())})}
function getDisplayName(){return ui.fields.display_name.val()}function getTimestamp(){return(new Date).getTime().toString()}function getTimezone(){return(new Date).getTimezoneOffset().toString()}function toTwoDigits(a){return 10>a?"0"+a:a}$(document).ready(function(){readQueryParameters();activateFieldValidation();bindActions();refreshGroup()});
